name: Deploy Docs Site to Linux Server

on:
  push:
    branches:
      - main
    paths:
      - 'docs-site/**'
      - '.github/workflows/deploy-docs-site.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: docs-site/package-lock.json

      - name: Install dependencies
        run: |
          cd docs-site
          npm ci

      - name: Build docs-site
        run: |
          cd docs-site
          npm run build

      - name: Create deployment archive
        run: |
          cd docs-site
          tar -czf ../docs-site-dist.tar.gz dist/

      - name: Deploy to Linux Server via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "docs-site-dist.tar.gz"
          target: "/tmp"
          strip_components: 0

      - name: Extract and deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            # Set deployment directory (adjust as needed)
            DEPLOY_DIR="${{ secrets.DEPLOY_DIR || '/var/www/vstats-docs' }}"
            BACKUP_DIR="${DEPLOY_DIR}.backup.$(date +%Y%m%d_%H%M%S)"
            
            # Create deployment directory if it doesn't exist
            sudo mkdir -p "$DEPLOY_DIR"
            
            # Backup existing deployment if it exists
            if [ -d "$DEPLOY_DIR/dist" ]; then
              echo "Backing up existing deployment..."
              sudo cp -r "$DEPLOY_DIR" "$BACKUP_DIR"
            fi
            
            # Extract new deployment
            echo "Extracting new deployment..."
            cd /tmp
            tar -xzf docs-site-dist.tar.gz
            
            # Copy files to deployment directory
            echo "Copying files to deployment directory..."
            sudo cp -r dist/* "$DEPLOY_DIR/"
            
            # Set proper permissions
            echo "Setting permissions..."
            sudo chown -R ${{ secrets.DEPLOY_USER }}:${{ secrets.DEPLOY_USER }} "$DEPLOY_DIR"
            sudo chmod -R 755 "$DEPLOY_DIR"
            
            # Restart web server (adjust based on your setup: nginx, apache, etc.)
            if command -v systemctl > /dev/null; then
              # If using systemd service
              if systemctl is-active --quiet vstats-docs; then
                echo "Restarting vstats-docs service..."
                sudo systemctl restart vstats-docs || true
              fi
              
              # If using nginx
              if systemctl is-active --quiet nginx; then
                echo "Reloading nginx..."
                sudo systemctl reload nginx || true
              fi
              
              # If using apache
              if systemctl is-active --quiet apache2; then
                echo "Reloading apache2..."
                sudo systemctl reload apache2 || true
              fi
            fi
            
            # Cleanup
            echo "Cleaning up..."
            rm -f /tmp/docs-site-dist.tar.gz
            rm -rf /tmp/dist
            
            echo "Deployment completed successfully!"
            echo "Deployment directory: $DEPLOY_DIR"
            if [ -d "$BACKUP_DIR" ]; then
              echo "Backup saved at: $BACKUP_DIR"
            fi

      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Files deployed to server" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Web server reloaded" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Host:** \`${{ secrets.DEPLOY_HOST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Directory:** \`${{ secrets.DEPLOY_DIR || '/var/www/vstats-docs' }}\`" >> $GITHUB_STEP_SUMMARY
